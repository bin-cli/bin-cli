#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."

RESET=$'\e[0m'
BOLD=$'\e[1m'
UNDERLINE=$'\e[4m'
LRED=$'\e[91m'
LGREEN=$'\e[92m'
LMAGENTA=$'\e[95m'
LCYAN=$'\e[96m'

result=0

# Build
bin/generate/bin || exit

# Run tests
bin/cucumber --fail-fast "$@" || result=$?

# If it failed, output debugging information
if [[ -f /tmp/bin-cli/command.txt ]]; then
    echo
    echo "${LMAGENTA}${BOLD}${UNDERLINE}Command${RESET}"
    cat /tmp/bin-cli/command.txt
fi

if [[ -f /tmp/bin-cli/stdout.txt ]]; then
    echo
    echo "${LGREEN}${BOLD}${UNDERLINE}Output${RESET}"
    cat /tmp/bin-cli/stdout.txt
fi

if [[ -f /tmp/bin-cli/stderr.txt ]]; then
    echo
    echo "${LRED}${BOLD}${UNDERLINE}Errors${RESET}"
    cat /tmp/bin-cli/stderr.txt
fi

if [[ -f /tmp/bin-cli/debug.txt ]]; then
    echo
    echo "${LCYAN}${BOLD}${UNDERLINE}Debug log${RESET}"
    cat /tmp/bin-cli/debug.txt
fi

# Return the result code
exit $result
