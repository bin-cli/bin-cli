#!/usr/bin/env bash
set -o errexit -o nounset -o pipefail
cd "$(dirname "$0")/.."

RESET=$'\e[0m'
BOLD=$'\e[1m'
UNDERLINE=$'\e[4m'
LRED=$'\e[91m'
LGREEN=$'\e[92m'
LMAGENTA=$'\e[95m'
LCYAN=$'\e[96m'

result=0

# Build
bin/build || result=$?

# Run tests
if [[ $result -eq 0 ]]; then
    bin/cucumber --fail-fast "$@" || result=$?
fi

# If it failed, output debugging information
if [[ -f temp/root/command.txt ]]; then
    echo
    echo "${LMAGENTA}${BOLD}${UNDERLINE}Command${RESET}"
    cat temp/root/command.txt
fi

if [[ -f temp/root/stdout.txt ]]; then
    echo
    echo "${LGREEN}${BOLD}${UNDERLINE}Output${RESET}"
    cat temp/root/stdout.txt
fi

if [[ -f temp/root/stderr.txt ]]; then
    echo
    echo "${LRED}${BOLD}${UNDERLINE}Errors${RESET}"
    cat temp/root/stderr.txt
fi

if [[ -f temp/root/debug.txt ]]; then
    echo
    echo "${LCYAN}${BOLD}${UNDERLINE}Debug log${RESET}"
    cat temp/root/debug.txt
fi

# Return the result code
exit $result
