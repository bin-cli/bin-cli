#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."

if [[ ${1-} = '--help' || ${1-} = '-h' ]]; then
    echo "Usage: ${BIN_COMMAND-$0} [CUCUMBER.JS OPTIONS...]"
    echo
    echo 'Run tests, then wait for something to change and run them again.'
    exit
fi

while true; do

    # Output some blank space because Tmux doesn't insert any into the
    # scrollback buffer, making it hard to see where the new run started
    printf '%*s' "$(tput lines)" '' | tr ' ' '\n'
    printf '%*s\n' "$(tput cols)" '' | tr ' ' '='
    echo " $(date)"
    printf '%*s\n' "$(tput cols)" '' | tr ' ' '='

    # Clear the screen
    clear

    # Build and test it
    bin/test "$@" || true

    # Wait until something changes
    inotifywait -qqr \
        -e create -e modify -e move -e attrib -e delete \
        bin/build features src

done
