#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/../.."

html=false
if [[ ${1-} = '--html' ]]; then
    html=true
    shift
fi

page=${1-bin.1}
version=${2-v1.2.3}

if $html; then

    mkdir -p temp/pages

    sed -E "s/\\\$VERSION/$version/g" "src/$page.md" |
        # '+hard_line_breaks' preserves line breaks in the source file
        # '-raw_html' so we don't have to escape '<root>', for example
        # '-smart' prevents '--' being converted to an en-dash
        # Clearing the 'title' var so no <h1> is generated but <title> is still set
        pandoc \
            --standalone \
            --from markdown+hard_line_breaks-raw_html-smart \
            --to html \
            --css 'pandoc.css' \
            --variable title='' \
        > "temp/pages/$page.html"

else

    mkdir -p temp/dist

    sed -E "s/\\\$VERSION/$version/g" "src/$page.md" |
        # Can't use '--shift-heading-level-by -1' while Ubuntu 20.04 is still supported
        sed -E '/^# /d; s/^#(#+) /\1 /' |
        pandoc \
            --standalone \
            --from markdown+hard_line_breaks-raw_html-smart \
            --to man \
            --metadata date="$(date +'%B %Y')" \
            --metadata header='Bin CLI Manual' \
            --metadata footer="Bin CLI $version" |
        gzip -9 \
        > "temp/dist/$page.gz"

fi
