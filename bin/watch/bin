#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/../.."

while true; do

    # Output some blank space because Tmux doesn't insert any into the
    # scrollback buffer, making it hard to see where the new run started
    printf '%*s' "$(tput lines)" '' | tr ' ' '\n'
    printf '%*s\n' "$(tput cols)" '' | tr ' ' '='
    echo " $(date)"
    printf '%*s\n' "$(tput cols)" '' | tr ' ' '='

    # Clear the screen
    clear

    # Build and test it
    bin/test "$@" || true

    # Wait until something changes
    inotifywait -qqr \
        -e create -e modify -e move -e attrib -e delete \
        --exclude '.*~$' \
        bin/generate/bin features src

    # Wait a moment for everything to settle
    sleep 0.2

done
